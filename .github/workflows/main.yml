name: Linux VPS

on:
  workflow_dispatch:

jobs:
  ubuntu-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # -------------------------------------------------
      # 1. Create SSH User for VPS access
      # -------------------------------------------------
      - name: Setup SSH User
        run: |
          PASSWORD=$(openssl rand -base64 16)
          echo "PASSWORD=$PASSWORD" >> $GITHUB_ENV

          sudo useradd -m -s /bin/bash vps
          echo "vps:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo vps

          echo "âœ… User 'vps' created with a random password."

      # -------------------------------------------------
      # 2. Install & connect Tailscale for remote SSH
      # -------------------------------------------------
      - name: Install and Run Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntu-runner
          echo "âœ… Tailscale connected."

      # -------------------------------------------------
      # 3. Install Python + PyDrive2
      # -------------------------------------------------
      - name: Install Python & PyDrive2
        run: |
          sudo apt update -y
          sudo apt install -y python3 python3-pip unzip
          pip install pydrive2 google-auth google-auth-oauthlib
          echo "âœ… Python & dependencies installed."

      # -------------------------------------------------
      # 4. Write credentials.json from GitHub Secret
      # -------------------------------------------------
      - name: Write Google Credentials
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS_JSON }}
        run: |
          mkdir -p ~/.gdrive
          echo "$GDRIVE_CREDENTIALS" > ~/.gdrive/credentials.json
          echo "âœ… credentials.json written."

      # -------------------------------------------------
      # 5. Download File from Google Drive
      # -------------------------------------------------
      - name: Download File from Google Drive
        env:
          GDRIVE_FILE_ID: ${{ secrets.GDRIVE_FILE_ID }}
        run: |
          python3 - <<'PYCODE'
          from pydrive2.auth import GoogleAuth
          from pydrive2.drive import GoogleDrive

          gauth = GoogleAuth()
          gauth.LoadCredentialsFile("/home/runner/.gdrive/credentials.json")
          if gauth.credentials is None:
              gauth.CommandLineAuth()
          elif gauth.access_token_expired:
              gauth.Refresh()
          else:
              gauth.Authorize()

          drive = GoogleDrive(gauth)
          file_id = "${{ env.GDRIVE_FILE_ID }}"
          file = drive.CreateFile({'id': file_id})
          print(f"â¬‡ï¸ Downloading {file['title']} ...")
          file.GetContentFile(file['title'])
          print("âœ… Download complete.")
          PYCODE

      # -------------------------------------------------
      # 6. Extract ZIP (if applicable)
      # -------------------------------------------------
      - name: Extract Archive (optional)
        run: |
          unzip -o *.zip || echo "Not a ZIP file, skipping extraction."
          echo "âœ… Extraction complete."

      # -------------------------------------------------
      # 7. Run the Script
      # -------------------------------------------------
      - name: Run the Script
        run: |
          echo "ðŸš€ Running script..."
          python3 your_script.py  # Change to your filename
          echo "âœ… Script finished."

      # -------------------------------------------------
      # 8. Show SSH connection info
      # -------------------------------------------------
      - name: Display Connection Details & Keep Alive
        run: |
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "================================================="
          echo "    SSH Connection Details"
          echo "================================================="
          echo "IP Address: $TS_IP"
          echo "Username:   vps"
          echo "Password:   ${{ env.PASSWORD }}"
          echo ""
          echo "To connect: ssh vps@$TS_IP"
          echo "================================================="
          for i in {1..6}; do
            echo "[$(date)] Session active..."
            sleep 300
          done
